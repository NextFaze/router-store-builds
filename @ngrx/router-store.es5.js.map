{"version":3,"file":"router-store.es5.js","sources":["../../../modules/router-store/index.ts","../../../modules/router-store/src/router_store_module.ts"],"sourcesContent":["/**\n * Generated bundle index. Do not edit.\n */\n\nexport {ROUTER_ERROR,ROUTER_CANCEL,ROUTER_NAVIGATION,routerReducer,RouterErrorPayload,RouterReducerState,RouterCancelPayload,RouterNavigationPayload,StoreRouterConnectingModule} from './public_api';\n","import {NgModule} from '@angular/core';\nimport {NavigationCancel, NavigationError, Router, RouterStateSnapshot, RoutesRecognized} from '@angular/router';\nimport {Store} from '@ngrx/store';\nimport {of} from 'rxjs/observable/of';\n/**\n * An action dispatched when the router navigates.\n */\nexport const ROUTER_NAVIGATION = 'ROUTER_NAVIGATION';\n\n/**\n * Payload of ROUTER_NAVIGATION.\n */\nexport type RouterNavigationPayload = {\n  routerState: RouterStateSnapshot,\n  event: RoutesRecognized\n};\n/**\n * An action dispatched when the router cancels navigation.\n */\nexport const ROUTER_CANCEL = 'ROUTER_CANCEL';\n\n/**\n * Payload of ROUTER_CANCEL.\n */\nexport type RouterCancelPayload<T> = {\n  routerState: RouterStateSnapshot,\n  storeState: T,\n  event: NavigationCancel\n};\n/**\n * An action dispatched when the router errors.\n */\nexport const ROUTER_ERROR = 'ROUTE_ERROR';\n\n/**\n * Payload of ROUTER_ERROR.\n */\nexport type RouterErrorPayload<T> = {\n  routerState: RouterStateSnapshot,\n  storeState: T,\n  event: NavigationError\n};\n\nexport type RouterReducerState = { state: RouterStateSnapshot, navigationId: number };\n/**\n * @param {?} state\n * @param {?} action\n * @return {?}\n */\nexport function routerReducer(state: RouterReducerState, action: any): RouterReducerState {\n  if (action.type === 'ROUTER_NAVIGATION' || action.type === 'ROUTER_ERROR' || action.type === 'ROUTER_CANCEL') {\n    return ({ state: action.payload.routerState, navigationId: action.payload.event.id });\n  } else {\n    return state;\n  }\n}\n/**\n * Connects RouterModule with StoreModule.\n * \n * During the navigation, before any guards or resolvers run, the router will dispatch\n * a ROUTER_NAVIGATION action, which has the following signature:\n * \n * ```\n * export type RouterNavigationPayload = {\n *   routerState: RouterStateSnapshot,\n *   event: RoutesRecognized\n * }\n * ```\n * \n * Either a reducer or an effect can be invoked in response to this action.\n * If the invoked reducer throws, the navigation will be canceled.\n * \n * If navigation gets canceled because of a guard, a ROUTER_CANCEL action will be\n * dispatched. If navigation results in an error, a ROUTER_ERROR action will be dispatched.\n * \n * Both ROUTER_CANCEL and ROUTER_ERROR contain the store state before the navigation\n * which can be used to restore the consistency of the store.\n * \n * Usage:\n * \n * ```typescript\n * \\@NgModule({ \n *   declarations: [AppCmp, SimpleCmp],\n *   imports: [\n *     BrowserModule,\n *     StoreModule.provideStore(mapOfReducers),\n *     RouterModule.forRoot([\n *       { path: '', component: SimpleCmp },\n *       { path: 'next', component: SimpleCmp }\n *     ]),\n *     StoreRouterConnectingModule\n *   ],\n *   bootstrap: [AppCmp]\n * })\n * export class AppModule {\n * }\n * ```\n */\nexport class StoreRouterConnectingModule {\nprivate routerState: RouterStateSnapshot | null = null;\nprivate storeState: any;\nprivate lastRoutesRecognized: RoutesRecognized;\nprivate dispatchTriggeredByRouter: boolean = false;\nprivate navigationTriggeredByDispatch: boolean = false;\n/**\n * @param {?} store\n * @param {?} router\n */\nconstructor(private store: Store<any>,\nprivate router: Router) {\n    this.setUpBeforePreactivationHook();\n    this.setUpStoreStateListener();\n    this.setUpStateRollbackEvents();\n  }\n/**\n * @return {?}\n */\nprivate setUpBeforePreactivationHook(): void {\n    ( /** @type {?} */((<any>this.router))).hooks.beforePreactivation = (routerState: RouterStateSnapshot) => {\n      this.routerState = routerState;\n      if (this.shouldDispatch()) this.dispatchEvent();\n      return of(true);\n    };\n  }\n/**\n * @return {?}\n */\nprivate setUpStoreStateListener(): void {\n    this.store.subscribe(s => {\n      this.storeState = s;\n      this.navigateIfNeeded();\n    });\n  }\n/**\n * @return {?}\n */\nprivate dispatchEvent(): void {\n    this.dispatchTriggeredByRouter = true;\n    try {\n      const /** @type {?} */ payload = { routerState: this.routerState, event: this.lastRoutesRecognized };\n      this.store.dispatch({ type: ROUTER_NAVIGATION, payload });\n    } finally {\n      this.dispatchTriggeredByRouter = false;\n      this.navigationTriggeredByDispatch = false;\n    }\n  }\n/**\n * @return {?}\n */\nprivate shouldDispatch(): boolean {\n    if (!this.storeState['routerReducer']) return true;\n    return !this.navigationTriggeredByDispatch;\n  }\n/**\n * @return {?}\n */\nprivate navigateIfNeeded(): void {\n    if (!this.storeState['routerReducer']) return;\n    if (this.dispatchTriggeredByRouter) return;\n\n    if (this.router.url !== this.storeState['routerReducer'].state.url) {\n      this.navigationTriggeredByDispatch = true;\n      this.router.navigateByUrl(this.storeState['routerReducer'].state.url);\n    }\n  }\n/**\n * @return {?}\n */\nprivate setUpStateRollbackEvents(): void {\n    this.router.events.subscribe(e => {\n      if (e instanceof RoutesRecognized) {\n        this.lastRoutesRecognized = e;\n      } else if (e instanceof NavigationCancel) {\n        this.dispatchRouterCancel(e);\n      } else if (e instanceof NavigationError) {\n        this.dispatchRouterError(e);\n      }\n    });\n  }\n/**\n * @param {?} event\n * @return {?}\n */\nprivate dispatchRouterCancel(event: NavigationCancel): void {\n    const /** @type {?} */ payload = { routerState: this.routerState, storeState: this.storeState, event };\n    this.store.dispatch({ type: ROUTER_CANCEL, payload });\n  }\n/**\n * @param {?} event\n * @return {?}\n */\nprivate dispatchRouterError(event: NavigationError): void {\n    const /** @type {?} */ payload = { routerState: this.routerState, storeState: this.storeState, event };\n    this.store.dispatch({ type: ROUTER_ERROR, payload });\n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: NgModule, args: [{}, ] },\n];\n/**\n * @nocollapse\n */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: Store, },\n{type: Router, },\n];\n}\n\nfunction StoreRouterConnectingModule_tsickle_Closure_declarations() {\n/** @type {?} */\nStoreRouterConnectingModule.decorators;\n/**\n * @nocollapse\n * @type {?}\n */\nStoreRouterConnectingModule.ctorParameters;\n/** @type {?} */\nStoreRouterConnectingModule.prototype.routerState;\n/** @type {?} */\nStoreRouterConnectingModule.prototype.storeState;\n/** @type {?} */\nStoreRouterConnectingModule.prototype.lastRoutesRecognized;\n/** @type {?} */\nStoreRouterConnectingModule.prototype.dispatchTriggeredByRouter;\n/** @type {?} */\nStoreRouterConnectingModule.prototype.navigationTriggeredByDispatch;\n/** @type {?} */\nStoreRouterConnectingModule.prototype.store;\n/** @type {?} */\nStoreRouterConnectingModule.prototype.router;\n}\n\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"],"names":[],"mappings":"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"}